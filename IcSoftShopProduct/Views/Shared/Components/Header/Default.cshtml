@using IcSoft.Infrastructure.Models
@using Microsoft.AspNetCore.Identity
@model HeaderViewModel
@inject UserManager<ShopUser> UserManager
@{
    var user = await UserManager.GetUserAsync(User);
}
 <!-- Mobile Menu -->
<nav class="mobile-menu">
    <div class="menu-left">
        <!-- Open Bar (Menu Icon) -->
        <a href="#" class="menu-icon" id="list">
            <i class="bi bi-list"></i>
        </a>
        <!-- Mobile Menu Content -->
        <div id="slideInMenu" class="slide-in-menu">
            <!-- Phần trên cùng -->
            <div class="slidermenu-top">
                <div class="icon-user">
                    <i class="bi bi-person"></i>
                </div>
                <div class="account-info">
                    <div class="account-top">
                        <ul class="account-ul">
                            <li>
                                @await Html.PartialAsync("_LoginPartial")
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <!-- Phần bên dưới -->
            <div class="slidermenu-bottom">
                <ul class="menu-items">
                    <li>
                        <a asp-controller="Product" asp-action="Shop">Sản phẩm</a>
                        <span id="showProductsMenu" class="arrow-icon"><i class="bi bi-chevron-right"></i></span>
                    </li>
                    <li>
                        <a href="#">Bộ sưu tập</a>
                        <span id="showCollectionsMenu" class="arrow-icon"><i class="bi bi-chevron-right"></i></span>
                   </li>
                    <li><a href="/Sale">Sale</a></li>
                    <li><a href="#">Thư viện</a></li>
                    <li><a href="#">Giới thiệu</a></li>
                </ul>
            </div>
        </div>

        <!-- Menu Trượt cho Sản Phẩm -->
        <div id="productsMenu" class="slide-in-menu submenu">
            <div class="submenu-top">
                <a href="#" id="backToMainMenu" class="back-button"><i class="bi bi-arrow-left"></i> Quay lại</a>
            </div>
            <div class="slidermenu-bottom">
                <ul class="menu-items">
                    <!-- Các danh mục sản phẩm -->
                    @foreach (var category in Model.categories)
                    {
                        <li><a asp-controller="Product" asp-action="ShopSearch" asp-route-searchname="@category.CategoryName.Replace(" ","-").ToLower()">@category.CategoryName</a></li>
                    }
                </ul>
            </div>
        </div>

        <!-- Menu Trượt cho Bộ Sưu Tập -->
        <div id="collectionsMenu" class="slide-in-menu submenu">
            <div class="submenu-top">
                <a href="#" id="backToMainMenuFromCollections" class="back-button"><i class="bi bi-arrow-left"></i> Quay lại</a>
            </div>
            <div class="slidermenu-bottom">
                <ul class="menu-items">
                    <!-- Các danh mục bộ sưu tập -->
                    @foreach (var collection in Model.collections)
                    {
                        <li><a asp-controller="Product" asp-action="ShopSearch" asp-route-searchname="@collection.CollectionName.Replace("/","").Replace(" ","").ToLower()">@collection.CollectionName</a></li>
                    }
                </ul>
            </div>
        </div>
 </div>
        <div class="menu-center">
            <!-- Logo -->
            <a href="#" class="menu-logo">
                <a href="/"><img src="~/img/logo.webp" alt=""></a>
            </a>
        </div>

        <div class="menu-right">
            <!-- Search Icon -->
            <a href="#" class="menu-icon" id="search">
                <i class="bi bi-search"></i>
            </a>
            @if (user != null)
            {
                <!-- Cart Icon -->
                <a asp-controller="Cart" asp-action="CartIndex" class="menu-icon">
                    <i class="bi bi-cart"></i>
                <span class="cart-item-count">@Model.Cartitemcount</span> 
                </a>
            }
            else
            {
                <a asp-area="Identity" asp-page="/Account/Login" class="menu-icon">
                    <i class="bi bi-cart"></i>
                    <span class="cart-item-count">@Model.Cartitemcount</span> 
                </a>
            }
        </div>
</nav>

<!-- Mobile Menu End -->
<!-- Header Section Begin -->
<div class="header__top">
    <div class="container">
        <div class="row" style="display:block !important">
            <div class="col-lg-12 col-md-12 text-center">
                <a class="position-relative d-block" href="/collections/all" title="FREE SHIPPING ON ALL ORDERS!" style="color: #ffffff">
                    FREE SHIPPING ON ALL ORDERS!
                </a>
                <button type="button" class="close " aria-label="Close"><span aria-hidden="true">×</span></button>

            </div>
        </div>
    </div>
</div>
<div class="custom-sticky-container">
    <div class="row desktop-menu">
        <div class="col-lg-2 col-md-2">
            <div class="header__logo menu-center">
                <a href="/"><img src="~/img/logo.webp" style="width:150px;height:50px"></a>
            </div>
        </div>
        <div class="col-lg-8 col-md-8 text-center">
            <nav class="header__menu">
                <ul>
                    <li id="sanpham">
                        <a id="shopall" href="/shopall">SẢN PHẨM</a>
                        <ul class="dropdown">
                            @foreach (var category in Model.categories)
                            {
                                <li><a asp-controller="Product" asp-action="ShopSearch" asp-route-searchname="@category.CategoryName.Replace(" ","-").ToLower()">@category.CategoryName</a></li>
                            }
                        </ul>
                    </li>
                    <li id="bosuutap">
                        <a href="#">BỘ SƯU TẬP</a>
                        <ul class="dropdown">
                            @foreach (var collection in Model.collections)
                            {
                                <li><a asp-controller="Product" asp-action="ShopSearch" asp-route-searchname="@collection.CollectionName.Replace("/","").Replace(" ","").ToLower()">@collection.CollectionName</a></li>
                            }
                        </ul>
                    </li>
                    <li id="sale"><a id="shopsale" href="/Sale">SALE</a></li>
                    <li><a href="/thu-vien">THƯ VIỆN</a></li>
                    <li><a href="./contact.html">GIỚI THIỆU</a></li>

                </ul>
            </nav>
        </div>
        <div class="col-lg-2 col-md-2" style="padding-right:40px">
            <div class="header__nav__option">
                <a href="#" class="menu-icon" id="search">
                    <i class="bi bi-search"></i>
                </a>
                <ul>
                    <li>
                        <a href="/#" class="menu-icon" id="person" style="font-size:26px !important">
                            <i class="bi bi-person"></i>
                        </a>
                        <ul class="dropdown">
                            <li>
                                @await Html.PartialAsync("_LoginPartial")
                            </li>
                        </ul>
                    </li>
                </ul>
        
                @if (user != null)
                {
                    <!-- Cart Icon -->
                    <a asp-controller="Cart" asp-action="CartIndex" class="menu-icon">
                        <i class="bi bi-cart"></i>
                        <span class="cart-item-count">@Model.Cartitemcount</span> <!-- Hiển thị số lượng sản phẩm ở đây -->
                    </a>
                }
                else
                {
                    <a asp-area="Identity" asp-page="/Account/Login" class="menu-icon">
                        <i class="bi bi-cart"></i>
                        <span class="cart-item-count">@Model.Cartitemcount</span> <!-- Hiển thị số lượng sản phẩm ở đây -->
                    </a>
                }
             
              
            </div>
        </div>
    </div>
</div>

<div class="search-custom">
    <div class="menu-left-search">
        <a href="#" class="menu-logo-search">
            <a href="/"><img src="~/img/logo.webp" alt=""></a>
        </a>
    </div>
    <div class="menu-center-search">
        <input type="text" id="search-input" class="search-input" placeholder="Tìm kiếm sản phẩm..." />
        <div id="search-results" class="search-results"></div> 
    </div>
    <div class="menu-right-search">
        <!-- Search Icon -->
        <a href="#" class="menu-icon" id="search-custom">
            <i class="bi bi-search"></i>
        </a>
        <ul>
            <li>
                <a href="/#" class="menu-icon" style="font-size:26px !important">
                    <i class="bi bi-person"></i>
                </a>
                <ul class="dropdown">
                    <li>
                        @await Html.PartialAsync("_LoginPartial")
                    </li>
                </ul>
            </li>
        </ul>

        @if (user != null)
        {
            <!-- Cart Icon -->
            <a asp-controller="Cart" asp-action="CartIndex" class="menu-icon">
                <i class="bi bi-cart"></i>
                <span class="cart-item-count">@Model.Cartitemcount</span> <!-- Hiển thị số lượng sản phẩm ở đây -->
            </a>
        }
        else
        {
            <a asp-area="Identity" asp-page="/Account/Login" class="menu-icon">
                <i class="bi bi-cart"></i>
                <span class="cart-item-count">@Model.Cartitemcount</span> <!-- Hiển thị số lượng sản phẩm ở đây -->
            </a>
        }
    </div>
</div>

<!-- Header Section End -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="~/js//header.js"></script>

<script>
        $(document).ready(function () {
        // Sự kiện khi người dùng gõ phím trong ô tìm kiếm
        $('#search-input').on('keyup', function () {
            const query = $(this).val().toLowerCase();

            if (query.length > 0) {
                $.ajax({
                    url: '/Product/Search', // Thay đổi URL này thành endpoint xử lý tìm kiếm
                    method: 'GET',
                    data: { query: query },
                    success: function (response) {
                        // Xóa kết quả tìm kiếm cũ
                        $('#search-results').empty();

                        if (response.success && response.products.length > 0) {
                            // Hiển thị danh sách sản phẩm

                            response.products.forEach(product => {
                            var HeaderImageUrl = product.productImage && product.productImage.length > 0 ? product.productImage[0].imageUrl : 'path/to/default-image.jpg';
                            var isSale = product.productSale > 0;
                            var ProductSale = product.productPrice - (product.productPrice * product.productSale) / 100;
                            var formattedPrice = new Intl.NumberFormat('vi-VN').format(product.productPrice) + '₫';
                            var formattedSalePrice = new Intl.NumberFormat('vi-VN').format(ProductSale) + '₫';
                                $('#search-results').append(`
                                    <div class="search-item">
                                        <img src="/${HeaderImageUrl}" />
                                        <div class="search-item-info">
                                                <a href="/${product.productName.replace(/ /g, '-').toLowerCase()}">
                                                     <p class="product-name">${product.productName}</p>
                                                    </a>
                                             ${isSale ? `
                                                     <div class="price-container">
                                                       <p class="product-price">${formattedSalePrice}</p>
                                                       <p class="product-price-sale">${formattedPrice}</p>
                                                     </div>
                                                       ` : `
                                                      <p class="product-price">${formattedPrice}</p>
                                              `}
                                        </div>
                                    </div>
                                `);
                            });
                        } else {
                            $('#search-results').append('<p class="no-results">Không tìm thấy sản phẩm</p>');
                        }

                        $('#search-results').show();
                    },
                    error: function () {
                        $('#search-results').empty();
                        $('#search-results').append('<p class="no-results">Có lỗi xảy ra. Vui lòng thử lại!</p>');
                        $('#search-results').show();
                    }
                });
            } else {
                $('#search-results').empty();
                $('#search-results').hide();
            }
        });
    });


</script>