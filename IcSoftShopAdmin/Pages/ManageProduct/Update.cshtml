@page "{id:int}"
@model IcSoftShopAdmin.Pages.ManageProduct.UpdateModel
@{
    var i = 0;
}

<h2>Cập nhật sản phẩm</h2>

<form method="post" enctype="multipart/form-data">
    <input type="hidden" asp-for="Product.ProductId" />
    <div class="row">
        <div class="form-group col-lg-6 col-12 col-md-6 mb-3">
            <label asp-for="Product.ProductName">Tên sản phẩm</label>
            <input asp-for="Product.ProductName" class="form-control" required/>
            <span asp-validation-for="Product.ProductName" class="text-danger"></span>
        </div>

        <div class="form-group col-lg-3 col-12 col-md-3 mb-3">
            <label asp-for="Product.ProductPrice">Giá sản phẩm</label>
            <input asp-for="Product.ProductPrice" class="form-control" required/>
            <span asp-validation-for="Product.ProductPrice" class="text-danger"></span>
        </div>

        <div class="form-group col-lg-3 col-12 col-md-3 mb-3">
            <label asp-for="Product.ProductQuantity">Số lượng</label>
            <input asp-for="Product.ProductQuantity" class="form-control" required/>
            <span asp-validation-for="Product.ProductQuantity" class="text-danger"></span>
        </div>

        <div class="form-group col-lg-9 col-12 col-md-12 mb-3">
            <label asp-for="Product.ProductDescription">Mô tả</label>
            <textarea asp-for="Product.ProductDescription" class="form-control" required></textarea>
        </div>

        <div class="form-group col-lg-3 col-12 col-md-3 mb-3">
            <label asp-for="Product.ProductSale">Giảm giá</label>
            <input asp-for="Product.ProductSale" class="form-control" />
            <span asp-validation-for="Product.ProductSale" class="text-danger"></span>
        </div>

        <div class="form-group col-12 col-md-6 mb-3">
            <label>Màu sắc</label>
            <div class="color-options d-flex flex-wrap">
                
                @foreach (var color in Model.AvailableColors)
                {
                    <div class="color-circle m-1">
                        <input type="checkbox" id="color_@color.ColorId" name="SelectedColorIds" value="@color.ColorId"
                        @(Model.SelectedColorIds.Contains(color.ColorId) ? "checked" : "") />
                        <label for="color_@color.ColorId" style="background-color:@color.ColorCode;"></label>
                    </div>
                }
            </div>
            <span asp-validation-for="SelectedColorIds" class="text-danger"></span>
        </div>

        <div class="form-group col-12 col-md-6 mb-3">
            <label>Kích thước</label>
            <div class="size-options d-flex flex-wrap">
                @foreach (var size in Model.AvailableSizes)
                {
                    <input type="checkbox" id="size_@size.SizeId" name="SelectedSizeIds" value="@size.SizeId" class="size-checkbox"
                    @(Model.SelectedSizeIds.Contains(size.SizeId) ? "checked" :"")/>
                    <label for="size_@size.SizeId" class="size-square m-1">@size.SizeName</label>
                }
            </div>
            <span asp-validation-for="SelectedSizeIds" class="text-danger"></span>
        </div>

        <div class="form-group col-12 col-md-6 mb-3">
            <label asp-for="Product.CategoryID">Danh Mục</label>
            <select asp-for="Product.CategoryID" asp-items="Model.Categories" class="form-control" required>
            </select>
            <span asp-validation-for="Product.CategoryID" class="text-danger"></span>
        </div>


        <div class="form-group col-12 col-md-6 mb-3">
            <label asp-for="Product.CollectionID">Bộ Sưu Tập</label>
            <select asp-for="Product.CollectionID" asp-items="Model.Collections" class="form-control" required>
            </select>
            <span asp-validation-for="Product.CollectionID" class="text-danger"></span>
        </div>

        <!-- Hidden inputs lưu danh sách các ImageId bị xóa -->
        <div id="RemovedImageIdsContainer"></div>



        <label for="ProductImages">Hình ảnh sản phẩm</label>
       
            <div id="imageUploadContainer" class="d-flex flex-wrap">

            @foreach (var image in Model.Product.ProductImage)
            {
                <div class="form-group col-3 mb-3">
                    <div class="image-upload-container">
                        <!-- Gắn ImageId vào name của input để biết ảnh nào được thay -->
                        <input type="file" accept="image/*" class="d-none"
                               id="ProductImages_@image.ImageId"
                               name="ProductImages_@image.ImageId"
                               onchange="previewImage(this);" />
                        <div class="image-preview" onclick="document.getElementById('ProductImages_@image.ImageId').click();">
                            <img src="@Model.DomainUrl/@image.ImageUrl" alt="Product Image @image.ImageId" />
                            <span class="remove-image" onclick="removeImage(this, @image.ImageId)">X</span>
                        </div>
                    </div>
                </div>
            }


            </div>
            <span asp-validation-for="ProductImages" class="text-danger"></span>
            <button type="button" id="addImageButton" class="btn btn-secondary col-lg-2 ">Thêm ảnh</button>
    


        <div class="col-12">
            <button type="submit" id="submitBtn" class="btn btn-primary">Lưu</button>
        </div>
    </div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>

            document.getElementById('submitBtn').addEventListener('click', function(event) {
             // Kiểm tra màu sắc và kích thước
             const selectedColor = document.querySelectorAll('input[name="SelectedColorIds"]:checked');
             const selectedSize = document.querySelectorAll('input[name="SelectedSizeIds"]:checked');

             const productImages = document.querySelectorAll('.image-upload-container input');

             // Nếu không có màu sắc, kích thước hoặc hình ảnh, hiển thị cảnh báo
              if (selectedColor.length === 0 || selectedSize.length === 0 || productImages.length ===0) {
                 alert("Vui lòng chọn màu sắc, kích thước và ít nhất một hình ảnh.");
                 event.preventDefault();  // Ngừng gửi form nếu thiếu thông tin
             }
         });




        let imageIndex = @Model.Product.ProductImage.Count() + 1; // Đếm số lượng khung ảnh
        // Hàm xem trước ảnh
        function previewImage(input) {
            const imagePreview = input.nextElementSibling;
            const file = input.files[0];

            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;

                    // Xóa nội dung hiện tại của imagePreview và thêm ảnh
                    imagePreview.innerHTML = ''; 
                    imagePreview.appendChild(img); 

                    // Thêm dấu "X" để xóa ảnh
                    const removeSpan = document.createElement('span');
                    removeSpan.className = 'remove-image';
                    removeSpan.textContent = 'X';
                    removeSpan.onclick = function () {
                        removeImage(this);
                    };
                    imagePreview.appendChild(removeSpan);
                };
                reader.readAsDataURL(file);
            }
        }

       // Hàm xóa ảnh và thêm ImageId vào danh sách đã xóa
        function removeImage(element, imageId) {
            const imageContainer = element.closest('.form-group');
            const removedImagesContainer = document.getElementById('RemovedImageIdsContainer'); 

            // Tạo một hidden input cho mỗi ImageId bị xóa
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'RemovedImageIds'; 
            hiddenInput.value = imageId;

            removedImagesContainer.appendChild(hiddenInput);

            imageContainer.remove();

            event.stopPropagation();
        }



        // Thêm sự kiện cho nút "Thêm ảnh"
        document.getElementById('addImageButton').addEventListener('click', function () {
            const newDiv = document.createElement('div');
            newDiv.className = 'form-group col-3 mb-3';

            const newImageUploadContainer = document.createElement('div');
            newImageUploadContainer.className = 'image-upload-container';

            // Tạo input file mới
            const newInput = document.createElement('input');
            newInput.type = 'file';
            newInput.accept = 'image/*';
            newInput.className = 'd-none';
            newInput.name = 'ProductImages';
            const newInputId = 'ProductImages_' + imageIndex; 
            newInput.id = newInputId;
            newInput.onchange = function () {
                previewImage(this);
            };

            const newImagePreview = document.createElement('div');
            newImagePreview.className = 'image-preview';
            newImagePreview.onclick = function () {
                document.getElementById(newInputId).click();
            };

            const newSpan = document.createElement('span');
            newSpan.className = 'add-image-icon';
            newSpan.innerHTML = '+';

            const newP = document.createElement('p');
            newP.textContent = 'Thêm hình ảnh';

            // Thêm dấu "X" vào khung mới
            const newRemoveSpan = document.createElement('span');
            newRemoveSpan.className = 'remove-image';
            newRemoveSpan.textContent = 'X';
            newRemoveSpan.onclick = function () {
                removeImage(this);
            };

            newImagePreview.appendChild(newSpan);
            newImagePreview.appendChild(newP);
            newImagePreview.appendChild(newRemoveSpan); 

            newImageUploadContainer.appendChild(newInput);
            newImageUploadContainer.appendChild(newImagePreview);
            newDiv.appendChild(newImageUploadContainer);

            document.getElementById('imageUploadContainer').appendChild(newDiv);

            imageIndex++;
        });
    </script>

}
